# üß™ Implementa√ß√£o Completa de Testes de Integra√ß√£o

**Data:** 04/10/2025  
**Status:** ‚úÖ Fase 1 e 2 Conclu√≠das | ‚è≥ Fase 3 Pendente (Playwright E2E)

---

## üì¶ O QUE FOI IMPLEMENTADO

### ‚úÖ 1. Depend√™ncias Instaladas

```bash
npm install -D supertest @types/supertest @faker-js/faker msw@latest @playwright/test
npx playwright install chromium
```

**Pacotes:**
- `supertest` (3.4.2) - Testes de API REST
- `@faker-js/faker` (9.3.0) - Gera√ß√£o de dados fake pt_BR
- `msw` (2.x) - Mock Service Worker para APIs externas
- `@playwright/test` (1.49.1) - Testes E2E full-stack

---

### ‚úÖ 2. Mocks MSW para APIs Externas

**Localiza√ß√£o:** `backend/src/__tests__/mocks/`

#### 2.1. Coinzz API Mock (`coinzz.mock.ts`)
- ‚úÖ GET /sales - Sync de vendas
- ‚úÖ GET /customers - Listar clientes
- ‚úÖ POST /webhook/delivery - Webhook de entrega
- ‚úÖ GET /products - Listar produtos
- ‚úÖ POST /auth/test - Testar conex√£o
- ‚úÖ Handlers de erro (401, 429, 500)

#### 2.2. Facebook Ads API Mock (`facebook.mock.ts`)
- ‚úÖ GET /oauth/access_token - OAuth callback
- ‚úÖ GET /me/adaccounts - Listar ad accounts
- ‚úÖ GET /act_:accountId/insights - Buscar insights
- ‚úÖ GET /act_:accountId/campaigns - Listar campanhas
- ‚úÖ GET /me - Verificar token
- ‚úÖ GET /debug_token - Validar token
- ‚úÖ Handlers de erro (401, 403, 429)

#### 2.3. WhatsApp Business API Mock (`whatsapp.mock.ts`)
- ‚úÖ POST /:phoneNumberId/messages - Enviar template
- ‚úÖ GET /:phoneNumberId - Buscar informa√ß√µes do n√∫mero
- ‚úÖ POST /webhook/whatsapp - Webhook de status
- ‚úÖ GET /webhook/whatsapp - Verifica√ß√£o de webhook
- ‚úÖ GET /message_templates - Listar templates aprovados
- ‚úÖ Mock payloads de webhook (sent, delivered, read)
- ‚úÖ Handlers de erro (400, 429)

#### 2.4. PagBank API Mock (`pagbank.mock.ts`)
- ‚úÖ POST /subscriptions - Criar assinatura
- ‚úÖ GET /subscriptions/:code - Buscar assinatura
- ‚úÖ PUT /subscriptions/:code/cancel - Cancelar
- ‚úÖ PUT /subscriptions/:code/suspend - Suspender
- ‚úÖ PUT /subscriptions/:code/activate - Reativar
- ‚úÖ POST /subscriptions/:code/payment-orders - Cobrar
- ‚úÖ GET /transactions/notifications/:code - Consultar notifica√ß√£o
- ‚úÖ POST /webhook/pagbank - Webhook de pagamento
- ‚úÖ Mock payloads de webhook (approved, declined, cancelled)
- ‚úÖ Handlers de erro (401, 404, 400)

#### 2.5. Index Centralizado (`index.ts`)
- ‚úÖ Exporta todos os handlers e servers
- ‚úÖ Fun√ß√µes `setupAllMockServers()`, `startAllMockServers()`, `stopAllMockServers()`, `resetAllMockServers()`

---

### ‚úÖ 3. Factories com @faker

**Localiza√ß√£o:** `backend/src/__tests__/factories/`

#### 3.1. Client Factory (`client.factory.ts`)
```typescript
// Fun√ß√µes dispon√≠veis:
- createClient() - Cliente fake completo com locale pt_BR
- createManyClients(count) - M√∫ltiplos clientes
- createVIPClient() - Cliente alto valor (R$ 10k-100k)
- createInactiveClient() - Cliente inativo
- createNewClient() - Cliente novo sem compras

// Campos gerados:
- name: Nome brasileiro realista
- email: Email baseado no nome
- phone: Telefone brasileiro (+55 11 9####-####)
- cpf: CPF formato v√°lido (fake)
- address, city, state, cep: Endere√ßo completo
- status: ACTIVE, INACTIVE, PENDING
- external_id: ID Coinzz (60% de chance)
- total_spent: R$ 0 - R$ 50.000
- total_orders: 0 - 100
- last_order_at: 70% de chance nos √∫ltimos 90 dias
```

#### 3.2. Sale Factory (`sale.factory.ts`)
```typescript
// Fun√ß√µes dispon√≠veis:
- createSale() - Venda fake completa
- createManySales(count) - M√∫ltiplas vendas
- createPaidSale() - Venda paga (status PAID)
- createPendingSale() - Venda pendente (boleto)
- createHighValueSale() - Venda alto valor (R$ 3k-10k)
- createRecentSale() - Venda recente (√∫ltimos 7 dias)

// Campos gerados:
- product_name: Curso, Ebook, Consultoria, etc.
- product_sku: SKU alfanum√©rico (60% de chance)
- quantity: 1-3 unidades
- unit_price: R$ 97 - R$ 5.000
- total_price: Calculado automaticamente
- commission: 10% do total (50% de chance)
- status: PAID, PENDING, CANCELLED, REFUNDED
- payment_method: credit_card, pix, boleto, debit_card
- payment_date: 70% de chance nos √∫ltimos 30 dias
- shipped_at, delivered_at: Datas realistas
- external_id: ID Coinzz (80% de chance)
```

#### 3.3. User Factory (`user.factory.ts`)
```typescript
// Fun√ß√µes dispon√≠veis:
- createUser() - Usu√°rio fake completo
- createManyUsers(count) - M√∫ltiplos usu√°rios
- createTrialUser() - Trial 7 dias
- createActiveUser() - Assinatura ativa
- createAdminUser() - Admin
- createSuspendedUser() - Suspenso
- createCancelledUser() - Cancelado
- createTestUser() - test@flowzz.com.br (senha: Test@123)
- createTestAdmin() - admin@flowzz.com.br (senha: Test@123)

// Campos gerados:
- email: Email brasileiro
- password_hash: Bcrypt hash de "Test@123" (12 rounds)
- nome: Nome completo brasileiro
- role: USER, ADMIN
- subscription_status: TRIAL, ACTIVE, CANCELLED, SUSPENDED
- trial_ends_at: 30% de chance de ter trial
- is_active: 90% de chance de estar ativo
```

#### 3.4. Index Centralizado (`index.ts`)
- ‚úÖ Exporta todas as fun√ß√µes das factories

---

### ‚úÖ 4. Helpers de Banco de Dados

**Localiza√ß√£o:** `backend/src/__tests__/helpers/database.ts`

```typescript
// Fun√ß√µes dispon√≠veis:
- resetDatabase() - Trunca todas as tabelas
- seedDatabase() - Executa seed.ts
- resetAndSeedDatabase() - Reset + Seed
- connectDatabase() - Conecta ao Prisma
- disconnectDatabase() - Desconecta do Prisma
- executeRawQuery(query) - Executa SQL raw
- clearTable(tableName) - Limpa tabela espec√≠fica
- setupTestDatabase() - Setup global (beforeAll)
- teardownTestDatabase() - Cleanup global (afterAll)

// Export da inst√¢ncia Prisma:
- prisma - Inst√¢ncia do PrismaClient para uso direto
```

---

### ‚úÖ 5. Testes de Integra√ß√£o Backend (API E2E)

**Localiza√ß√£o:** `backend/src/__tests__/integration/`

#### 5.1. Auth E2E Tests (`auth.e2e.test.ts`)

**Cobertura Completa:**
- ‚úÖ POST /api/v1/auth/register
  - Registrar novo usu√°rio com trial 7 dias
  - Validar erro 400 para email duplicado
  - Validar erro 400 para senha fraca
  
- ‚úÖ POST /api/v1/auth/login
  - Login com credenciais demo do seed
  - Login com admin do seed
  - Validar erro 401 para credenciais inv√°lidas
  - Validar erro 401 para senha incorreta
  
- ‚úÖ POST /api/v1/auth/refresh
  - Renovar accessToken com refreshToken v√°lido
  - Validar erro 401 para refreshToken inv√°lido
  - Validar erro 401 para refreshToken expirado
  
- ‚úÖ POST /api/v1/auth/logout
  - Invalidar refreshToken ao fazer logout
  - Verificar remo√ß√£o do token no banco
  - Validar que refresh token n√£o funciona ap√≥s logout
  
- ‚úÖ GET /api/v1/auth/me
  - Retornar dados do usu√°rio autenticado
  - Validar erro 401 sem token
  - Validar erro 401 com token inv√°lido

**Total:** 13 test cases implementados

**Uso:**
```bash
npm run test:integration
# ou
vitest run src/__tests__/integration/auth.e2e.test.ts
```

---

### ‚úÖ 6. Scripts package.json Atualizados

```json
{
  "scripts": {
    "test": "vitest",                          // Roda todos os testes
    "test:unit": "vitest run src/__tests__/unit",  // Apenas unit tests
    "test:integration": "vitest run src/__tests__/integration",  // Apenas integration tests
    "test:e2e": "playwright test",             // E2E com Playwright (a implementar)
    "test:all": "npm run test && npm run test:e2e",  // Roda tudo
    "test:watch": "vitest --watch",            // Watch mode
    "test:coverage": "vitest --coverage"       // Com coverage
  }
}
```

---

## üìä ESTRUTURA DE DIRET√ìRIOS CRIADA

```
backend/src/__tests__/
‚îú‚îÄ‚îÄ mocks/                  # ‚úÖ MSW handlers para APIs externas
‚îÇ   ‚îú‚îÄ‚îÄ coinzz.mock.ts      # 173 linhas - Coinzz API
‚îÇ   ‚îú‚îÄ‚îÄ facebook.mock.ts    # 210 linhas - Facebook Ads API
‚îÇ   ‚îú‚îÄ‚îÄ whatsapp.mock.ts    # 283 linhas - WhatsApp Business API
‚îÇ   ‚îú‚îÄ‚îÄ pagbank.mock.ts     # 245 linhas - PagBank API
‚îÇ   ‚îî‚îÄ‚îÄ index.ts            # 84 linhas - Centralizador
‚îÇ
‚îú‚îÄ‚îÄ factories/              # ‚úÖ Factories @faker para dados fake
‚îÇ   ‚îú‚îÄ‚îÄ client.factory.ts   # 87 linhas - Clientes brasileiros
‚îÇ   ‚îú‚îÄ‚îÄ sale.factory.ts     # 100 linhas - Vendas realistas
‚îÇ   ‚îú‚îÄ‚îÄ user.factory.ts     # 143 linhas - Usu√°rios c/ bcrypt
‚îÇ   ‚îî‚îÄ‚îÄ index.ts            # 32 linhas - Centralizador
‚îÇ
‚îú‚îÄ‚îÄ helpers/                # ‚úÖ Helpers utilit√°rios
‚îÇ   ‚îî‚îÄ‚îÄ database.ts         # 108 linhas - Gerenciamento DB
‚îÇ
‚îú‚îÄ‚îÄ integration/            # ‚úÖ Testes de integra√ß√£o E2E
‚îÇ   ‚îî‚îÄ‚îÄ auth.e2e.test.ts    # 340 linhas - 13 test cases
‚îÇ
‚îú‚îÄ‚îÄ unit/                   # (J√° existente)
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ repositories/
‚îÇ
‚îî‚îÄ‚îÄ (pendente) e2e/         # ‚è≥ Playwright full-stack E2E
    ‚îú‚îÄ‚îÄ flow/               # Testes frontend usu√°rio
    ‚îú‚îÄ‚îÄ admin/              # Testes frontend admin
    ‚îî‚îÄ‚îÄ auth/               # Sessions salvas
```

**Total de linhas adicionadas:** ~1.800 linhas de c√≥digo de teste

---

## üéØ PR√ìXIMOS PASSOS (FASE 3)

### ‚è≥ 1. Testes de Integra√ß√£o Backend Restantes

**Arquivos a criar:**

#### `dashboard.e2e.test.ts` (estimativa: 200 linhas)
```typescript
describe('Dashboard E2E Tests', () => {
  - GET /api/v1/dashboard/metrics
    - Calcular m√©tricas com dados do seed
    - Validar cache Redis (5min TTL)
    - Testar com usu√°rio sem vendas
    
  - GET /api/v1/dashboard/chart
    - Retornar dados para gr√°fico (7d, 30d, 90d)
    - Validar formato de resposta
    
  - GET /api/v1/dashboard/activities
    - Listar √∫ltimas 20 atividades
    - Testar pagina√ß√£o
});
```

#### `clients.e2e.test.ts` (estimativa: 300 linhas)
```typescript
describe('Clients E2E Tests', () => {
  - GET /api/v1/clients (lista com pagina√ß√£o)
  - GET /api/v1/clients/:id (buscar espec√≠fico)
  - POST /api/v1/clients (criar com valida√ß√£o)
  - PUT /api/v1/clients/:id (atualizar)
  - DELETE /api/v1/clients/:id (soft delete)
  
  // Testes com factories
  - Listar 50 clientes (usar createManyClients)
  - Filtrar por status (ACTIVE, INACTIVE, PENDING)
  - Buscar por nome/email
  - Testar isolamento multi-tenancy
});
```

---

### ‚è≥ 2. Configurar Playwright E2E Full-Stack

**Arquivos a criar:**

#### `playwright.config.ts` (raiz do projeto)
```typescript
import { defineConfig } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  use: {
    baseURL: 'http://localhost:3000',
  },
  webServer: [
    { command: 'cd backend && npm run dev', port: 4000 },
    { command: 'cd flow && npm run dev', port: 3000 },
    { command: 'cd admin && npm run dev', port: 5173 },
  ],
  projects: [
    { name: 'flow', testDir: './e2e/flow' },
    { name: 'admin', testDir: './e2e/admin', use: { baseURL: 'http://localhost:5173' } },
  ],
});
```

#### `e2e/auth/setup.ts`
```typescript
// Gerar session files para reutilizar autentica√ß√£o
// demo-user.json, admin-user.json
```

#### `e2e/flow/dashboard.spec.ts`
```typescript
test('Ver dashboard com dados do seed', async ({ page }) => {
  await page.goto('http://localhost:3000/dashboard');
  await expect(page.locator('[data-testid="vendas-hoje"]')).toBeVisible();
  // ... valida√ß√µes
});
```

#### `e2e/admin/metrics.spec.ts`
```typescript
test('Ver m√©tricas SaaS', async ({ page }) => {
  await page.goto('http://localhost:5173/admin/metrics');
  await expect(page.locator('[data-testid="mrr"]')).toBeVisible();
  // ... valida√ß√µes
});
```

---

## üìö COMO USAR

### 1. Rodar Testes de Integra√ß√£o Backend

```bash
# Setup inicial (apenas 1x)
npm run db:migrate
npm run db:seed

# Rodar todos os testes de integra√ß√£o
npm run test:integration

# Rodar apenas auth tests
vitest run src/__tests__/integration/auth.e2e.test.ts

# Watch mode
npm run test:watch
```

### 2. Usar Factories nos Testes

```typescript
import { createClient, createManyClients, createVIPClient } from '../factories';
import { prisma } from '../helpers/database';

// Criar 1 cliente
const client = await prisma.client.create({
  data: createClient({
    user: { connect: { id: userId } },
    name: 'Nome Customizado',
  }),
});

// Criar 50 clientes
const clients = createManyClients(50, {
  user: { connect: { id: userId } },
});

await prisma.client.createMany({ data: clients });

// Criar cliente VIP
const vip = await prisma.client.create({
  data: createVIPClient({
    user: { connect: { id: userId } },
  }),
});
```

### 3. Usar MSW nos Testes

```typescript
import { coinzzServer, coinzzErrorHandlers } from '../mocks';

describe('Coinzz Integration Tests', () => {
  beforeAll(() => coinzzServer.listen());
  afterEach(() => coinzzServer.resetHandlers());
  afterAll(() => coinzzServer.close());

  test('Sync vendas com sucesso', async () => {
    // coinzzServer mockar√° automaticamente as chamadas HTTP
    const sales = await CoinzzService.syncSales(userId);
    expect(sales).toHaveLength(2);
  });

  test('Simular rate limit', async () => {
    // Substituir handler para simular erro
    coinzzServer.use(...coinzzErrorHandlers);
    
    await expect(CoinzzService.syncSales(userId)).rejects.toThrow();
  });
});
```

### 4. Gerenciar Banco de Dados

```typescript
import { resetDatabase, seedDatabase, prisma } from '../helpers/database';

beforeEach(async () => {
  await resetDatabase(); // Limpa todas as tabelas
  await seedDatabase();   // Popula com dados demo
});

// Ou usar seed existente + adicionar dados fake
beforeEach(async () => {
  await resetAndSeedDatabase();
  
  // Adicionar 10 clientes fake al√©m do seed
  const fakeClients = createManyClients(10, {
    user: { connect: { email: 'demo@flowzz.com.br' } },
  });
  
  await prisma.client.createMany({ data: fakeClients });
});
```

---

## üîß TROUBLESHOOTING

### Erro: "Cannot find module '../server'"
**Solu√ß√£o:** Verificar se `export default app` existe em `server.ts`

### Erro: "ECONNREFUSED" ao rodar testes
**Solu√ß√£o:** Garantir que PostgreSQL est√° rodando:
```bash
docker-compose up -d
```

### Erro: "seed.ts not found"
**Solu√ß√£o:** Verificar path em `database.ts`:
```typescript
const seedPath = path.join(__dirname, '../../prisma/seed.ts');
```

### Testes ficam pendentes sem rodar
**Solu√ß√£o:** Aumentar timeout do Vitest:
```typescript
// No beforeAll
beforeAll(async () => {
  await setupTestDatabase();
}, 30000); // 30 segundos
```

---

## üìà M√âTRICAS DE SUCESSO

### Estado Atual
- ‚úÖ **Testes Unit√°rios:** 256/308 passando (83.1%)
- ‚úÖ **MSW Mocks:** 4 APIs externas completas
- ‚úÖ **Factories:** 3 entidades principais (Client, Sale, User)
- ‚úÖ **Testes Integra√ß√£o:** 13 test cases (auth)
- ‚è≥ **Testes E2E:** 0 (a implementar)

### Meta Final (Estimativa)
- üéØ **Testes Unit√°rios:** 290/308 passando (94%)
- üéØ **Testes Integra√ß√£o:** 50+ test cases
- üéØ **Testes E2E:** 10 fluxos cr√≠ticos
- üéØ **Coverage Total:** >85%

---

## üéâ PR√ìXIMA A√á√ÉO RECOMENDADA

1. **Rodar testes de integra√ß√£o auth:**
   ```bash
   npm run test:integration
   ```

2. **Implementar dashboard.e2e.test.ts e clients.e2e.test.ts**

3. **Configurar Playwright ap√≥s backends estarem 100% testados**

4. **Documentar casos de uso no README.md**

---

**Documenta√ß√£o gerada em:** 04/10/2025 23:45  
**Vers√£o:** 1.0.0  
**Autor:** GitHub Copilot + Mau  
**Total de implementa√ß√£o:** ~3 horas  
**Linhas de c√≥digo:** ~1.800 linhas
