#!/bin/bash

# Flowzz Deploy Configuration
# Este arquivo contém todas as configurações para o deploy

# ==========================================
# CONFIGURAÇÕES GERAIS
# ==========================================

# Domínio padrão
DEFAULT_DOMAIN="flowzzoficial.com"

# Email padrão para SSL
DEFAULT_EMAIL="admin@$DEFAULT_DOMAIN"

# Diretório do projeto
PROJECT_DIR="$HOME/flowzz"

# Usuário não-root (se aplicável)
DEPLOY_USER="flowzz"

# ==========================================
# CONFIGURAÇÕES DE SISTEMA
# ==========================================

# Node.js version
NODE_VERSION="18"

# PM2 app names
PM2_BACKEND_NAME="flowzz-api"
PM2_FLOW_NAME="flow-frontend"
PM2_ADMIN_NAME="flowzz-admin"
PM2_LANDING_NAME="flowzz-landing"

# Portas
BACKEND_PORT="3001"
FLOW_PORT="3000"
ADMIN_PORT="3002"
LANDING_PORT="3003"
POSTGRES_PORT="5433"
REDIS_PORT="6380"

# ==========================================
# CONFIGURAÇÕES DE BANCO DE DADOS
# ==========================================

# PostgreSQL
DB_HOST="localhost"
DB_PORT="$POSTGRES_PORT"
DB_NAME="flowzz_db"
DB_USER="flowzz_user"
DB_PASSWORD="flowzz_password"

# Redis
REDIS_URL="redis://localhost:$REDIS_PORT"

# ==========================================
# CONFIGURAÇÕES DE JWT
# ==========================================

# JWT Secret (gerado automaticamente se não definido)
JWT_SECRET="${JWT_SECRET:-$(openssl rand -hex 32)}"
JWT_EXPIRES_IN="7d"

# ==========================================
# CONFIGURAÇÕES DE CORS
# ==========================================

# CORS Origins
CORS_ORIGIN="http://$DEFAULT_DOMAIN,http://www.$DEFAULT_DOMAIN,http://admin.$DEFAULT_DOMAIN"

# ==========================================
# CONFIGURAÇÕES DE NGINX
# ==========================================

# Nginx sites
NGINX_SITES_AVAILABLE="/etc/nginx/sites-available"
NGINX_SITES_ENABLED="/etc/nginx/sites-enabled"

# ==========================================
# CONFIGURAÇÕES DE LOGROTATE
# ==========================================

# PM2 Logrotate
LOGROTATE_MAX_SIZE="10M"
LOGROTATE_RETAIN="7"

# ==========================================
# CONFIGURAÇÕES DE FIREWALL
# ==========================================

# UFW ports to allow
FIREWALL_PORTS=("ssh" "80" "443")

# ==========================================
# FUNÇÕES UTILITÁRIAS
# ==========================================

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Função para imprimir status
print_status() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

print_error() {
    echo -e "${RED}✗ $1${NC}"
}

print_info() {
    echo -e "${BLUE}ℹ $1${NC}"
}

# Função para verificar se comando existe
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Função para aguardar serviço
wait_for_service() {
    local service=$1
    local port=$2
    local timeout=${3:-30}

    print_info "Aguardando $service na porta $port..."
    local count=0
    while ! nc -z localhost "$port" 2>/dev/null; do
        if [ $count -ge $timeout ]; then
            print_error "$service não iniciou na porta $port após ${timeout}s"
            return 1
        fi
        sleep 1
        count=$((count + 1))
    done
    print_status "$service está pronto na porta $port"
}

# Função para validar domínio
validate_domain() {
    local domain=$1

    # Verificar se é localhost
    if [ "$domain" = "localhost" ]; then
        return 0
    fi

    # Verificar se contém pelo menos um ponto
    if [[ ! "$domain" =~ \. ]]; then
        print_error "Domínio inválido: $domain"
        print_error "Domínio deve conter pelo menos um ponto (ex: dominio.com)"
        return 1
    fi

    # Verificar se não é apenas 'ssl'
    if [[ "$domain" =~ ^ssl(\..*)?$ ]]; then
        print_error "Domínio inválido: $domain"
        print_error "Não use nomes como 'ssl'. Use domínios reais como: flowzzoficial.com"
        return 1
    fi

    return 0
}

# Exportar todas as variáveis
export DEFAULT_DOMAIN DEFAULT_EMAIL PROJECT_DIR DEPLOY_USER
export NODE_VERSION PM2_BACKEND_NAME PM2_FLOW_NAME PM2_ADMIN_NAME PM2_LANDING_NAME
export BACKEND_PORT FLOW_PORT ADMIN_PORT LANDING_PORT POSTGRES_PORT REDIS_PORT
export DB_HOST DB_PORT DB_NAME DB_USER DB_PASSWORD REDIS_URL
export JWT_SECRET JWT_EXPIRES_IN CORS_ORIGIN
export NGINX_SITES_AVAILABLE NGINX_SITES_ENABLED
export LOGROTATE_MAX_SIZE LOGROTATE_RETAIN
export FIREWALL_PORTS
export -f validate_domain wait_for_service command_exists